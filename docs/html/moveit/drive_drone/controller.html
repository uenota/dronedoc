

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="ja" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="ja" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>コード解説（コントローラ) &mdash; Dronedoc 1.0.0 ドキュメント</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Dronedoc
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">SLAM</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">はじめに</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../px4sim/px4sim.html">PX4 SITLシミュレーション</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../runnode/runnodecpp.html">自作ノードを実行する（C++）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../runnode/runnodepy.html">自作ノードを実行する（Python）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../addmodel/addmodel.html">新しいモデルを追加する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/slam.html">自律飛行とSLAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/gps_nav.html">GPSを用いた自律飛行</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/turtle_mapping.html">Turtlebotを使ってマップを作る</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../teleop/teleop.html">ゲームパッドを使ってドローンを操作する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/lidar_localization.html">LiDARとAMCLを用いた自己位置推定</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/localization_and_mapping.html">LiDARを用いたSLAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/lidar_nav.html">LiDARを用いた自律移動</a></li>
</ul>
<p class="caption"><span class="caption-text">Mapping</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../octomap/octomap.html">Octomapを使って3Dマップを作る</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_map_gmapping/build_map_gmapping.html">Gmappingを使って地図を生成する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_map_gazebo_plugin/build_map_gazebo_plugin.html">Gazebo Pluginを使って地図を作成する</a></li>
</ul>
<p class="caption"><span class="caption-text">Motion Planning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">MoveIt!を使ってドローンの経路計画を行う</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../local_planner_for_uav/local_planner_for_uav.html">UAV用のローカルプランナを実装する</a></li>
</ul>
<p class="caption"><span class="caption-text">Tips</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../qgc_intro/qgc_intro.html">QGroundControl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../add_range_sensor/add_range_sensor.html">ドローンに距離センサを搭載する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filter_lidar/filter_lidar.html">LiDARのデータをフィルタリングする</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../change_local_planner/change_local_planner.html">move_baseのローカルプランナーを変更する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../airsim/airsim.html">AirSimシミュレータを使う</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/bash_commands/bash_commands.html">基本的なBashの使い方</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/ros/ros.html">ROSの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/terms/terms.html">用語集</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/archive/archive.html">読書案内</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/trouble_shooting/index.html">トラブルシューティング</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Dronedoc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>コード解説（コントローラ)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/moveit/drive_drone/controller.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>コード解説（コントローラ)<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="literal-block-wrapper container" id="id6">
<div class="code-block-caption"><span class="caption-text">drone_controller.cpp</span><a class="headerlink" href="#id6" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * @file drone_controller.cpp</span>
<span class="cm"> * @brief PX4 based UAV controller for moveit</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;array&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cmath&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;ros/ros.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;geometry_msgs/Transform.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;geometry_msgs/PoseStamped.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;moveit_msgs/ExecuteTrajectoryAction.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;moveit_msgs/RobotTrajectory.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;mavros_msgs/State.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;trajectory_msgs/MultiDOFJointTrajectory.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;trajectory_msgs/MultiDOFJointTrajectoryPoint.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;actionlib/server/simple_action_server.h&gt;</span><span class="cp"></span>

<span class="k">class</span> <span class="nc">DroneController</span><span class="p">{</span>

<span class="k">private</span><span class="o">:</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">nh_</span><span class="p">;</span>
    <span class="c1">//! Action name of ExecuteTrajectory</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">action_name_</span><span class="p">;</span>
    <span class="c1">//! Server of ExecuteTrajectoryAction</span>
    <span class="n">actionlib</span><span class="o">::</span><span class="n">SimpleActionServer</span><span class="o">&lt;</span><span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryAction</span><span class="o">&gt;</span> <span class="n">as_</span><span class="p">;</span>
    <span class="c1">//! Feedback message of ExecuteTrajectoryAction</span>
    <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryFeedback</span> <span class="n">feedback_</span><span class="p">;</span>
    <span class="c1">//! Result message of ExecuteTrajectoryAction</span>
    <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryResult</span> <span class="n">result_</span><span class="p">;</span>
    <span class="c1">//! Position command publisher</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">cmd_pos_pub_</span><span class="p">;</span>
    <span class="c1">//! Subscriber of local position</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Subscriber</span> <span class="n">local_pos_sub_</span><span class="p">;</span>
    <span class="c1">//! Subscriber of UAV state</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Subscriber</span> <span class="n">state_sub_</span><span class="p">;</span>
    <span class="c1">//! Current pose of UAV</span>
    <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">current_pose_</span><span class="p">;</span>
    <span class="c1">//! Current state of UAV</span>
    <span class="n">mavros_msgs</span><span class="o">::</span><span class="n">State</span> <span class="n">current_state_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Constructor</span>
<span class="cm">     * @param action_name Action name</span>
<span class="cm">     */</span>
    <span class="n">DroneController</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">action_name</span><span class="p">)</span> <span class="o">:</span>
        <span class="n">action_name_</span><span class="p">(</span><span class="n">action_name</span><span class="p">),</span>
        <span class="n">as_</span><span class="p">(</span><span class="n">nh_</span><span class="p">,</span> <span class="n">action_name</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DroneController</span><span class="o">::</span><span class="n">executeCb</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">),</span> <span class="nb">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">as_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

        <span class="c1">// Position command publisher setup</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">cmd_pos_topic</span><span class="p">;</span>
        <span class="n">nh_</span><span class="p">.</span><span class="n">param</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;mavros_setpoint_topic&quot;</span><span class="p">,</span> <span class="n">cmd_pos_topic</span><span class="p">,</span> <span class="s">&quot;/mavros/setpoint_position/local&quot;</span><span class="p">);</span>
        <span class="n">cmd_pos_pub_</span> <span class="o">=</span> <span class="n">nh_</span><span class="p">.</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cmd_pos_topic</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

        <span class="c1">// Local position subscriber setup</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">local_pos_topic</span><span class="p">;</span>
        <span class="n">nh_</span><span class="p">.</span><span class="n">param</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;mavros_localpos_topic&quot;</span><span class="p">,</span> <span class="n">local_pos_topic</span><span class="p">,</span> <span class="s">&quot;/mavros/local_position/pose&quot;</span><span class="p">);</span>
        <span class="k">auto</span> <span class="n">local_pos_cb</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DroneController</span><span class="o">::</span><span class="n">localPosCb</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">);</span>
        <span class="n">local_pos_sub_</span> <span class="o">=</span> <span class="n">nh_</span><span class="p">.</span><span class="n">subscribe</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span><span class="p">(</span><span class="n">local_pos_topic</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">local_pos_cb</span><span class="p">);</span>

        <span class="c1">// UAV state subscriber setup</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">state_topic</span><span class="p">;</span>
        <span class="n">nh_</span><span class="p">.</span><span class="n">param</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;mavros_state_topic&quot;</span><span class="p">,</span> <span class="n">state_topic</span><span class="p">,</span> <span class="s">&quot;/mavros/state&quot;</span><span class="p">);</span>
        <span class="k">auto</span> <span class="n">state_cb</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DroneController</span><span class="o">::</span><span class="n">stateCb</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">);</span>
        <span class="n">state_sub_</span> <span class="o">=</span> <span class="n">nh_</span><span class="p">.</span><span class="n">subscribe</span><span class="o">&lt;</span><span class="n">mavros_msgs</span><span class="o">::</span><span class="n">State</span><span class="o">&gt;</span><span class="p">(</span><span class="n">state_topic</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">state_cb</span><span class="p">);</span>
        <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Action server initialized.&quot;</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Destructor</span>
<span class="cm">     */</span>
    <span class="o">~</span><span class="n">DroneController</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">};</span>

<span class="k">private</span><span class="o">:</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Callback of ExecuteTrajectory action</span>
<span class="cm">     * @param goal Goal of ExecuteTrajectory action</span>
<span class="cm">     */</span>
    <span class="kt">void</span> <span class="n">executeCb</span><span class="p">(</span><span class="k">const</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryGoalConstPtr</span> <span class="o">&amp;</span><span class="n">goal</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Action received.&quot;</span><span class="p">);</span>
        <span class="n">ros</span><span class="o">::</span><span class="n">Rate</span> <span class="n">rate</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">trajectory_msgs</span><span class="o">::</span><span class="n">MultiDOFJointTrajectoryPoint</span><span class="o">&gt;</span> <span class="n">trajectory</span><span class="p">;</span>
        <span class="n">trajectory</span> <span class="o">=</span> <span class="n">goal</span><span class="o">-&gt;</span><span class="n">trajectory</span><span class="p">.</span><span class="n">multi_dof_joint_trajectory</span><span class="p">.</span><span class="n">points</span><span class="p">;</span>

        <span class="c1">// Wait for connection</span>
        <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Waiting for FCU connection...&quot;</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">()</span> <span class="n">and</span> <span class="n">not</span> <span class="n">current_state_</span><span class="p">.</span><span class="n">connected</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ros</span><span class="o">::</span><span class="n">spinOnce</span><span class="p">();</span>
            <span class="n">rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;FCU connection established.&quot;</span><span class="p">);</span>

        <span class="c1">// Position command need to be published to switch mode to OFFBOARD</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">cmd_pos_pub_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">getPoseFromTrajectory</span><span class="p">(</span><span class="n">trajectory</span><span class="p">.</span><span class="n">front</span><span class="p">()));</span>
        <span class="p">}</span>


        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">trajectory</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Moving to waypoint No. %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

            <span class="c1">// Send feedback (progress of path)</span>
            <span class="n">feedback_</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="n">as_</span><span class="p">.</span><span class="n">publishFeedback</span><span class="p">(</span><span class="n">feedback_</span><span class="p">);</span>

            <span class="c1">// Get PoseStamped message from MultiDOFJointTrajectoryPoint</span>
            <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">start</span> <span class="o">=</span> <span class="n">getPoseFromTrajectory</span><span class="p">(</span><span class="n">trajectory</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
            <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">goal</span> <span class="o">=</span> <span class="n">getPoseFromTrajectory</span><span class="p">(</span><span class="n">trajectory</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
            <span class="c1">// Get interpolated path from two waypoints</span>
            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span> <span class="n">path</span> <span class="o">=</span> <span class="n">getBilinearPath</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">goal</span><span class="p">);</span>

            <span class="c1">// Publish all interpolated points</span>
            <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">pose</span><span class="p">:</span> <span class="n">path</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Publish same message till drone arrives to local goal</span>
                <span class="k">while</span><span class="p">(</span><span class="n">not</span> <span class="n">isGoalReached</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span> <span class="n">and</span> <span class="n">not</span> <span class="n">as_</span><span class="p">.</span><span class="n">isPreemptRequested</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="n">cmd_pos_pub_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">pose</span><span class="p">);</span>
                    <span class="n">rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="c1">// Exit loop if new action arrived</span>
                <span class="k">if</span><span class="p">(</span><span class="n">as_</span><span class="p">.</span><span class="n">isPreemptRequested</span><span class="p">()</span> <span class="n">or</span> <span class="n">not</span> <span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="n">result_</span><span class="p">.</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">MoveItErrorCodes</span><span class="o">::</span><span class="n">PREEMPTED</span><span class="p">;</span>
                    <span class="n">as_</span><span class="p">.</span><span class="n">setPreempted</span><span class="p">();</span>
                    <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Action preempted.&quot;</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">// Exit loop if new action arrived</span>
            <span class="k">if</span><span class="p">(</span><span class="n">as_</span><span class="p">.</span><span class="n">isPreemptRequested</span><span class="p">()</span> <span class="n">or</span> <span class="n">not</span> <span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">result_</span><span class="p">.</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">MoveItErrorCodes</span><span class="o">::</span><span class="n">PREEMPTED</span><span class="p">;</span>
                <span class="n">as_</span><span class="p">.</span><span class="n">setPreempted</span><span class="p">();</span>
                <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Action preempted.&quot;</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">// Success</span>
        <span class="n">result_</span><span class="p">.</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">MoveItErrorCodes</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">;</span>
        <span class="n">as_</span><span class="p">.</span><span class="n">setSucceeded</span><span class="p">(</span><span class="n">result_</span><span class="p">);</span>
        <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Action completed.&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Return interpolated path using bilinear interpolation from two waypoints</span>
<span class="cm">     * @param start Start waypoint</span>
<span class="cm">     * @param goal Goal waypoint</span>
<span class="cm">     * @param step Step size of interpolation</span>
<span class="cm">     */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span> <span class="n">getBilinearPath</span><span class="p">(</span><span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span>
                                                            <span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="o">&amp;</span><span class="n">goal</span><span class="p">,</span>
                                                            <span class="k">const</span> <span class="kt">double</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span> <span class="n">bilinear_path</span><span class="p">;</span>

        <span class="c1">// Store x-y and x-z coordinates of start point</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">start_xy</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">};</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">start_xz</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">};</span>
        <span class="c1">// Store x-y and x-z coordinates of goal point</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">goal_xy</span> <span class="o">=</span> <span class="p">{</span><span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">};</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">goal_xz</span> <span class="o">=</span> <span class="p">{</span><span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">};</span>

        <span class="c1">// x-y and x-z coordinates of interpolated points</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">points_xy</span> <span class="o">=</span> <span class="n">linearInterp</span><span class="p">(</span><span class="n">start_xy</span><span class="p">,</span> <span class="n">goal_xy</span><span class="p">,</span> <span class="n">step</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">points_xz</span> <span class="o">=</span> <span class="n">linearInterp</span><span class="p">(</span><span class="n">start_xz</span><span class="p">,</span> <span class="n">goal_xz</span><span class="p">,</span> <span class="n">step</span><span class="p">);</span>

        <span class="c1">// Number of generated points by interpolation</span>
        <span class="kt">int</span> <span class="n">num_points</span> <span class="o">=</span> <span class="n">points_xy</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">size</span><span class="p">();</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="c1">// Generate PoseStamped message from std::array</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_points</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">pose</span><span class="p">;</span>
                <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">;</span>
                <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">points_xy</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">points_xy</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">points_xz</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

                <span class="n">bilinear_path</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pose</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">out_of_range</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">bilinear_path</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Perform linear interpolation</span>
<span class="cm">     * @p1 First point</span>
<span class="cm">     * @p2 Second point</span>
<span class="cm">     * @step Step size of interpolation</span>
<span class="cm">     */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">linearInterp</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">p1</span><span class="p">,</span>
                                                    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">p2</span><span class="p">,</span> <span class="k">const</span> <span class="kt">double</span> <span class="n">step</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Gradient</span>
        <span class="kt">double</span> <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="c1">// Intercept</span>
        <span class="kt">double</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

        <span class="c1">// Number of steps</span>
        <span class="kt">int</span> <span class="n">num_steps</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">floor</span><span class="p">((</span><span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="n">step</span><span class="p">);</span>

        <span class="c1">// Initialize container for interpolated points</span>
        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">points_x</span><span class="p">(</span><span class="n">num_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

        <span class="c1">// Set interpolated points</span>
        <span class="n">points_x</span><span class="p">.</span><span class="n">front</span><span class="p">()</span> <span class="o">=</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_steps</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">points_x</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">points_x</span><span class="p">.</span><span class="n">back</span><span class="p">()</span> <span class="o">=</span> <span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

        <span class="c1">// Initialize container for interpolated points</span>
        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">points_y</span><span class="p">(</span><span class="n">num_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

        <span class="c1">// Set interpolated points</span>
        <span class="n">points_y</span><span class="p">.</span><span class="n">front</span><span class="p">()</span> <span class="o">=</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_steps</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">points_y</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">points_y</span><span class="p">.</span><span class="n">back</span><span class="p">()</span> <span class="o">=</span> <span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

        <span class="c1">// Initialize container for vector of points</span>
        <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">points</span><span class="p">;</span>
        <span class="n">points</span><span class="p">.</span><span class="n">front</span><span class="p">()</span> <span class="o">=</span> <span class="n">points_x</span><span class="p">;</span>
        <span class="n">points</span><span class="p">.</span><span class="n">back</span><span class="p">()</span> <span class="o">=</span> <span class="n">points_y</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">points</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Convert MultiDOFJointTrajectoryPoint message to PoseStamped message</span>
<span class="cm">     * @param trajectory_pt MultiDOFJointTrajectoryPoint message</span>
<span class="cm">     */</span>
    <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">getPoseFromTrajectory</span><span class="p">(</span><span class="k">const</span> <span class="n">trajectory_msgs</span><span class="o">::</span><span class="n">MultiDOFJointTrajectoryPoint</span> <span class="o">&amp;</span><span class="n">trajectory_pt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">pose</span><span class="p">;</span>

        <span class="n">pose</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">ros</span><span class="o">::</span><span class="n">Time</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">trajectory_pt</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">translation</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">trajectory_pt</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">translation</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">trajectory_pt</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">translation</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">trajectory_pt</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">rotation</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">pose</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Returns true if drone is reached goal</span>
<span class="cm">     * @param goal</span>
<span class="cm">     * @param tolerance Consider drone reached goal if drone is within the circle with diameter of this value</span>
<span class="cm">     */</span>
    <span class="kr">inline</span> <span class="kt">bool</span> <span class="n">isGoalReached</span><span class="p">(</span><span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="o">&amp;</span><span class="n">goal</span><span class="p">,</span> <span class="k">const</span> <span class="kt">double</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">double</span> <span class="n">error</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">current_pose_</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                                 <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">current_pose_</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                                 <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">current_pose_</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">tolerance</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Callback for local position subscriber</span>
<span class="cm">     * @msg Incoming message</span>
<span class="cm">     */</span>
    <span class="kt">void</span> <span class="n">localPosCb</span><span class="p">(</span><span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">::</span><span class="n">ConstPtr</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">current_pose_</span> <span class="o">=</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * @brief Callback for state subscriber</span>
<span class="cm">     * @msg Incoming message</span>
<span class="cm">     */</span>
    <span class="kt">void</span> <span class="n">stateCb</span><span class="p">(</span><span class="k">const</span> <span class="n">mavros_msgs</span><span class="o">::</span><span class="n">State</span><span class="o">::</span><span class="n">ConstPtr</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">current_state_</span> <span class="o">=</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="s">&quot;drone_controller&quot;</span><span class="p">);</span>

    <span class="n">DroneController</span> <span class="n">controller</span><span class="p">(</span><span class="s">&quot;iris_group_controller/follow_multi_dof_joint_trajectory&quot;</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">spin</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;array&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cmath&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;ros/ros.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;geometry_msgs/Transform.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;geometry_msgs/PoseStamped.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;moveit_msgs/ExecuteTrajectoryAction.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;moveit_msgs/RobotTrajectory.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;mavros_msgs/State.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;trajectory_msgs/MultiDOFJointTrajectory.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;trajectory_msgs/MultiDOFJointTrajectoryPoint.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;actionlib/server/simple_action_server.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<p>必要なヘッダファイルをインクルードします。
コントローラ内でアクションサーバを実装するので、actionlibのヘッダファイルもインクルードしています。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="c1">//! Action name of ExecuteTrajectory</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">action_name_</span><span class="p">;</span>
<span class="c1">//! Server of ExecuteTrajectoryAction</span>
<span class="n">actionlib</span><span class="o">::</span><span class="n">SimpleActionServer</span><span class="o">&lt;</span><span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryAction</span><span class="o">&gt;</span> <span class="n">as_</span><span class="p">;</span>
<span class="c1">//! Feedback message of ExecuteTrajectoryAction</span>
<span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryFeedback</span> <span class="n">feedback_</span><span class="p">;</span>
<span class="c1">//! Result message of ExecuteTrajectoryAction</span>
<span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryResult</span> <span class="n">result_</span><span class="p">;</span>
</pre></div>
</div>
<p>アクションサーバとサーバ名、サーバが使用するフィードバックとリザルトのメッセージを初期化します。
FollowMultiDOFJointTrajectoryインターフェースは、<a class="reference external" href="http://docs.ros.org/api/moveit_msgs/html/action/ExecuteTrajectory.html">ExecuteTrajectory</a> アクションを使用するので、アクションサーバを宣言する際のテンプレート引数として与えています。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="c1">//! Position command publisher</span>
<span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">cmd_pos_pub_</span><span class="p">;</span>
</pre></div>
</div>
<p>位置指令を送信するためのパブリッシャです。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="c1">//! Subscriber of local position</span>
<span class="n">ros</span><span class="o">::</span><span class="n">Subscriber</span> <span class="n">local_pos_sub_</span><span class="p">;</span>
<span class="c1">//! Subscriber of UAV state</span>
<span class="n">ros</span><span class="o">::</span><span class="n">Subscriber</span> <span class="n">state_sub_</span><span class="p">;</span>
<span class="c1">//! Current pose of UAV</span>
<span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">current_pose_</span><span class="p">;</span>
<span class="c1">//! Current state of UAV</span>
<span class="n">mavros_msgs</span><span class="o">::</span><span class="n">State</span> <span class="n">current_state_</span><span class="p">;</span>
</pre></div>
</div>
<p>ドローンの現在位置と状態を取得するためのパブリッシャとそれを格納するための変数です。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="n">DroneController</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">action_name</span><span class="p">)</span> <span class="o">:</span>
    <span class="n">action_name_</span><span class="p">(</span><span class="n">action_name</span><span class="p">),</span>
    <span class="n">as_</span><span class="p">(</span><span class="n">nh_</span><span class="p">,</span> <span class="n">action_name</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DroneController</span><span class="o">::</span><span class="n">executeCb</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">),</span> <span class="nb">false</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">as_</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>

    <span class="c1">// Position command publisher setup</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">cmd_pos_topic</span><span class="p">;</span>
    <span class="n">nh_</span><span class="p">.</span><span class="n">param</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;mavros_setpoint_topic&quot;</span><span class="p">,</span> <span class="n">cmd_pos_topic</span><span class="p">,</span> <span class="s">&quot;/mavros/setpoint_position/local&quot;</span><span class="p">);</span>
    <span class="n">cmd_pos_pub_</span> <span class="o">=</span> <span class="n">nh_</span><span class="p">.</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cmd_pos_topic</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

    <span class="c1">// Local position subscriber setup</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">local_pos_topic</span><span class="p">;</span>
    <span class="n">nh_</span><span class="p">.</span><span class="n">param</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;mavros_localpos_topic&quot;</span><span class="p">,</span> <span class="n">local_pos_topic</span><span class="p">,</span> <span class="s">&quot;/mavros/local_position/pose&quot;</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">local_pos_cb</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DroneController</span><span class="o">::</span><span class="n">localPosCb</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">);</span>
    <span class="n">local_pos_sub_</span> <span class="o">=</span> <span class="n">nh_</span><span class="p">.</span><span class="n">subscribe</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span><span class="p">(</span><span class="n">local_pos_topic</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">local_pos_cb</span><span class="p">);</span>

    <span class="c1">// UAV state subscriber setup</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">state_topic</span><span class="p">;</span>
    <span class="n">nh_</span><span class="p">.</span><span class="n">param</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;mavros_state_topic&quot;</span><span class="p">,</span> <span class="n">state_topic</span><span class="p">,</span> <span class="s">&quot;/mavros/state&quot;</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">state_cb</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DroneController</span><span class="o">::</span><span class="n">stateCb</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">);</span>
    <span class="n">state_sub_</span> <span class="o">=</span> <span class="n">nh_</span><span class="p">.</span><span class="n">subscribe</span><span class="o">&lt;</span><span class="n">mavros_msgs</span><span class="o">::</span><span class="n">State</span><span class="o">&gt;</span><span class="p">(</span><span class="n">state_topic</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">state_cb</span><span class="p">);</span>
    <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Action server initialized.&quot;</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">DroneController</span></code> クラスのコンストラクタです。
内部ではパブリッシャとサブスクライバ、アクションサーバの初期化を行っています。</p>
<p>使用するトピック名は、ROSの <a class="reference external" href="http://wiki.ros.org/roscpp/Overview/Parameter%20Server">パラメータサーバから取得</a> します。</p>
<p>サブスクライバとアクションサーバはコールバック関数を使用するので、メソッドをコールバック関数に指定するためにboost::functionオブジェクトを受け取る <a class="reference external" href="http://docs.ros.org/jade/api/roscpp/html/classros_1_1NodeHandle.html#a93b0fe95db250c45fdfbc5fd9f4c0159">関数</a> と、<a class="reference external" href="http://docs.ros.org/melodic/api/actionlib/html/classactionlib_1_1SimpleActionServer.html#a0f047d3a7474d3c2c1d3a0c7ef6adf16">コンストラクタ</a> をそれぞれ使用して初期化しています。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="kt">void</span> <span class="n">executeCb</span><span class="p">(</span><span class="k">const</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryGoalConstPtr</span> <span class="o">&amp;</span><span class="n">goal</span><span class="p">)</span>
</pre></div>
</div>
<p>アクションのコールバック関数です。
アクションゴールが届いたタイミングで実行されます。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">trajectory_msgs</span><span class="o">::</span><span class="n">MultiDOFJointTrajectoryPoint</span><span class="o">&gt;</span> <span class="n">trajectory</span><span class="p">;</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">goal</span><span class="o">-&gt;</span><span class="n">trajectory</span><span class="p">.</span><span class="n">multi_dof_joint_trajectory</span><span class="p">.</span><span class="n">points</span><span class="p">;</span>
</pre></div>
</div>
<p>アクションゴールは、<a class="reference external" href="http://docs.ros.org/melodic/api/moveit_msgs/html/msg/RobotTrajectory.html">moveit_msgs/RobotTrajectory</a> 型のメッセージなので、そこから経由点の配列を取り出しています。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Waiting for FCU connection...&quot;</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">()</span> <span class="n">and</span> <span class="n">not</span> <span class="n">current_state_</span><span class="p">.</span><span class="n">connected</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">spinOnce</span><span class="p">();</span>
    <span class="n">rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;FCU connection established.&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>ドローンに接続するまで待機します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">cmd_pos_pub_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">getPoseFromTrajectory</span><span class="p">(</span><span class="n">trajectory</span><span class="p">.</span><span class="n">front</span><span class="p">()));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>OFFBOARDモードに変更するためには予め <code class="docutils literal notranslate"><span class="pre">setpoint_position/local</span></code> トピックにメッセージがパブリッシュされている必要があるので、予めパブリッシュしておきます。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">trajectory</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Moving to waypoint No. %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</pre></div>
</div>
<p>各経由点を処理していきます。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="n">feedback_</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="n">as_</span><span class="p">.</span><span class="n">publishFeedback</span><span class="p">(</span><span class="n">feedback_</span><span class="p">);</span>
</pre></div>
</div>
<p>現在処理している経由点の番号をアクションのフィードバックとして登録します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">start</span> <span class="o">=</span> <span class="n">getPoseFromTrajectory</span><span class="p">(</span><span class="n">trajectory</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">goal</span> <span class="o">=</span> <span class="n">getPoseFromTrajectory</span><span class="p">(</span><span class="n">trajectory</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">trajectory_msgs/MultiDOFJointTrajectoryPoint</span></code> メッセージを、<code class="docutils literal notranslate"><span class="pre">geometry_msgs/PoseStamped</span></code> メッセージに変換します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span> <span class="n">path</span> <span class="o">=</span> <span class="n">getBilinearPath</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">goal</span><span class="p">);</span>
</pre></div>
</div>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Bilinear_interpolation">バイリニア補間</a> を行って経由点間の点の配列を取得します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">pose</span><span class="p">:</span> <span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
<p>取得した配列の各点について処理を行います。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="k">while</span><span class="p">(</span><span class="n">not</span> <span class="n">isGoalReached</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span> <span class="n">and</span> <span class="n">not</span> <span class="n">as_</span><span class="p">.</span><span class="n">isPreemptRequested</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">cmd_pos_pub_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">pose</span><span class="p">);</span>
    <span class="n">rate</span><span class="p">.</span><span class="n">sleep</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ドローンが次の点に到達するか、アクションを中止するリクエストが届くまで目標位置を送信し続けます。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="n">as_</span><span class="p">.</span><span class="n">isPreemptRequested</span><span class="p">()</span> <span class="n">or</span> <span class="n">not</span> <span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">result_</span><span class="p">.</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">MoveItErrorCodes</span><span class="o">::</span><span class="n">PREEMPTED</span><span class="p">;</span>
    <span class="n">as_</span><span class="p">.</span><span class="n">setPreempted</span><span class="p">();</span>
    <span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Action preempted.&quot;</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>アクションの中止がリクエストされた時には、状態を反映してアクションサーバを終了します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="n">result_</span><span class="p">.</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">MoveItErrorCodes</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="n">as_</span><span class="p">.</span><span class="n">setSucceeded</span><span class="p">(</span><span class="n">result_</span><span class="p">);</span>
<span class="n">ROS_INFO</span><span class="p">(</span><span class="s">&quot;Action completed.&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>ゴールまで移動したので結果を反映してクライアントへと送信します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span> <span class="n">getBilinearPath</span><span class="p">(</span><span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">,</span>
                                                        <span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="o">&amp;</span><span class="n">goal</span><span class="p">,</span>
                                                        <span class="k">const</span> <span class="kt">double</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">&gt;</span> <span class="n">bilinear_path</span><span class="p">;</span>

    <span class="c1">// Store x-y and x-z coordinates of start point</span>
    <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">start_xy</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">start_xz</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">};</span>
    <span class="c1">// Store x-y and x-z coordinates of goal point</span>
    <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">goal_xy</span> <span class="o">=</span> <span class="p">{</span><span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">goal_xz</span> <span class="o">=</span> <span class="p">{</span><span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">goal</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">};</span>

    <span class="c1">// x-y and x-z coordinates of interpolated points</span>
    <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">points_xy</span> <span class="o">=</span> <span class="n">linearInterp</span><span class="p">(</span><span class="n">start_xy</span><span class="p">,</span> <span class="n">goal_xy</span><span class="p">,</span> <span class="n">step</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">points_xz</span> <span class="o">=</span> <span class="n">linearInterp</span><span class="p">(</span><span class="n">start_xz</span><span class="p">,</span> <span class="n">goal_xz</span><span class="p">,</span> <span class="n">step</span><span class="p">);</span>

    <span class="c1">// Number of generated points by interpolation</span>
    <span class="kt">int</span> <span class="n">num_points</span> <span class="o">=</span> <span class="n">points_xy</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">size</span><span class="p">();</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="c1">// Generate PoseStamped message from std::array</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_points</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">pose</span><span class="p">;</span>
            <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">start</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">;</span>
            <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">points_xy</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">points_xy</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">points_xz</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

            <span class="n">bilinear_path</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pose</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">out_of_range</span> <span class="o">&amp;</span><span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">bilinear_path</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">geometry_msgs/PoseStamped</span></code> 型で表されたスタート地点とゴール地点の座標を受け取って、バイリニア補間を行い、補間された点の配列を返す関数です。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">linearInterp</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">p1</span><span class="p">,</span>
                                                <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">p2</span><span class="p">,</span> <span class="k">const</span> <span class="kt">double</span> <span class="n">step</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Gradient</span>
    <span class="kt">double</span> <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="c1">// Intercept</span>
    <span class="kt">double</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Number of steps</span>
    <span class="kt">int</span> <span class="n">num_steps</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">floor</span><span class="p">((</span><span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="n">step</span><span class="p">);</span>

    <span class="c1">// Initialize container for interpolated points</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">points_x</span><span class="p">(</span><span class="n">num_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Set interpolated points</span>
    <span class="n">points_x</span><span class="p">.</span><span class="n">front</span><span class="p">()</span> <span class="o">=</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_steps</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">points_x</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">points_x</span><span class="p">.</span><span class="n">back</span><span class="p">()</span> <span class="o">=</span> <span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Initialize container for interpolated points</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">points_y</span><span class="p">(</span><span class="n">num_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Set interpolated points</span>
    <span class="n">points_y</span><span class="p">.</span><span class="n">front</span><span class="p">()</span> <span class="o">=</span> <span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_steps</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">points_y</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">points_y</span><span class="p">.</span><span class="n">back</span><span class="p">()</span> <span class="o">=</span> <span class="n">p2</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Initialize container for vector of points</span>
    <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">points</span><span class="p">;</span>
    <span class="n">points</span><span class="p">.</span><span class="n">front</span><span class="p">()</span> <span class="o">=</span> <span class="n">points_x</span><span class="p">;</span>
    <span class="n">points</span><span class="p">.</span><span class="n">back</span><span class="p">()</span> <span class="o">=</span> <span class="n">points_y</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">points</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>二点の二次元座標を受け取って線形補間を行い、補間された点の座標の配列を返す関数です。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">getPoseFromTrajectory</span><span class="p">(</span><span class="k">const</span> <span class="n">trajectory_msgs</span><span class="o">::</span><span class="n">MultiDOFJointTrajectoryPoint</span> <span class="o">&amp;</span><span class="n">trajectory_pt</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span> <span class="n">pose</span><span class="p">;</span>

    <span class="n">pose</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">ros</span><span class="o">::</span><span class="n">Time</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
    <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">trajectory_pt</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">translation</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">trajectory_pt</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">translation</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">trajectory_pt</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">translation</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
    <span class="n">pose</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">trajectory_pt</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">rotation</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">pose</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">trajectory_msgs/MultiDOFJointTrajectoryPoint</span></code> メッセージを <code class="docutils literal notranslate"><span class="pre">geometry_msgs/PoseStamped</span></code> メッセージへ変更して返す関数です。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre>inline bool isGoalReached<span class="o">(</span>const geometry_msgs::PoseStamped <span class="p">&amp;</span>goal, const double <span class="nv">tolerance</span><span class="o">=</span>0.1<span class="o">)</span>
<span class="o">{</span>
    double <span class="nv">error</span> <span class="o">=</span> std::sqrt<span class="o">(</span>std::pow<span class="o">(</span>goal.pose.position.x - current_pose_.pose.position.x, 2<span class="o">)</span>
                            + std::pow<span class="o">(</span>goal.pose.position.y - current_pose_.pose.position.y, 2<span class="o">)</span>
                            + std::pow<span class="o">(</span>goal.pose.position.z - current_pose_.pose.position.z, 2<span class="o">))</span><span class="p">;</span>
    <span class="k">return</span> error &lt; tolerance ? <span class="nb">true</span> : false<span class="p">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>ドローンが目標位置に到達したかどうかを判断する関数です。
デフォルトでは、目標位置を中心とした0.1 m以内の球体内にドローンが存在する場合に目標位置へ到達したと判定します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="kt">void</span> <span class="nf">localPosCb</span><span class="p">(</span><span class="k">const</span> <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">PoseStamped</span><span class="o">::</span><span class="n">ConstPtr</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">current_pose_</span> <span class="o">=</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">stateCb</span><span class="p">(</span><span class="k">const</span> <span class="n">mavros_msgs</span><span class="o">::</span><span class="n">State</span><span class="o">::</span><span class="n">ConstPtr</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">current_state_</span> <span class="o">=</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ドローンの位置と状態のコールバック関数です。
それぞれメンバ変数に取得したメッセージを格納しています。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="s">&quot;drone_controller&quot;</span><span class="p">);</span>

    <span class="n">DroneController</span> <span class="n">controller</span><span class="p">(</span><span class="s">&quot;iris_group_controller/follow_multi_dof_joint_trajectory&quot;</span><span class="p">);</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">spin</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">drone_controller</span></code> ノード内でコントローラを初期化します。
FollowMultiDOFJointTrajectoryインターフェースが利用するメッセージは、<code class="docutils literal notranslate"><span class="pre">iris_group_controller/follow_multi_dof_joint_trajectory</span></code> 以下でやりとりされるので、これをコントローラのコンストラクタへ与えます。</p>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Takaki Ueno

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>